PERIOD: '.';
SEPARATOR: ',';
COLON: ':';
DOLLAR: '$';
HASH: '#';
AT: '@';
OPEN: '(';
CLOSE: ')';
STRING: /"[^"]*"|'[^']*'/;
INTEGER: /0|[1-9]\d*/;
IDENTIFIER: /[a-zA-Z_][a-zA-Z0-9_]*/;
DO: 'do';
DONE: 'done';
END: 'end';

SECTIONS: SECTION+; // This is the root element of the script

SECTION: BUTTON | COMMAND | INSTALL | DEFINITION | CAROUSEL | MENU | FLOW;


SLICE: /\*|\d*:?\d*/;

FIELD_OR_SLICE: IDENTIFIER | SLICE ;

MEMBER: PERIOD FIELD_OR_SLICE;
OBJECT: IDENTIFIER MEMBER*;

VARIABLE: DOLLAR OBJECT;
INTENT: HASH OBJECT;
ENTITY: AT OBJECT;

CONSTANT: 'nil' | 'true' | 'false';

OPERATOR: '+'
        | '-'
        | '/'
        | '*'
        | 'is not'
        | 'equal'
        | 'not equal'
        | 'has entity';
E: STRING | INTEGER | VARIABLE | INTENT | ENTITY | CONSTANT | IDENTIFIER;

EXPRESSION: E | E OPERATOR E;

SUBSCRIBE_FEED: 'subscribe' STRING;
UNSUBSCRIBE_FEED: 'unsubscribe' STRING;

HANDOFF_ARGUMENT: VARIABLE | STRING;

HANDOFF_ACTION: 'handoff' HANDOFF_ARGUMENT;

MEMBER_DEFINITION: IDENTIFIER COLON E;
LITERAL_OBJECT: MEMBER_DEFINITION+[SEPARATOR];


INNER_JSON_VALUE: JSON_OBJECT
                | JSON_ARRAY
                | STRING
                | INTEGER
                | CONSTANT
                | VARIABLE
                ;

JSON_ARRAY: '[' INNER_JSON_VALUE*[SEPARATOR] ']' ;
JSON_OBJECT: '{' KEY_VALUE*[SEPARATOR] '}' ;
JSON_VALUE: JSON_OBJECT | JSON_ARRAY ;
KEY_VALUE: IDENTIFIER ':' INNER_JSON_VALUE;

COMMAND: 'when' 'read' STRING 'do' IDENTIFIER;

INSTALL: 'install' IDENTIFIER 'using' STRING;

EXAMPLE_LIST: STRING*[SEPARATOR];
EXAMPLE_FILE: 'using' STRING;
EXAMPLES: EXAMPLE_LIST | EXAMPLE_FILE;

ELEMENT: 'intent' | 'entity';

FALLBACK: 'fallback' STRING;

DEFINITION: 'define' ELEMENT IDENTIFIER EXAMPLES;

/* Button definition to open a URL */
MESSAGE_BUTTON: 'message' OPEN STRING SEPARATOR STRING CLOSE;

/* Button definition to put text back to the conversation */
BUTTON_ATTRIBUTE: SEPARATOR IDENTIFIER COLON E;
BUTTON_TYPE: 'url' | 'postback';

BUTTON_WITH_PAYLOAD: BUTTON_TYPE OPEN STRING+[SEPARATOR] BUTTON_ATTRIBUTE* CLOSE;

/* Carousel buttons */
BUTTON: MESSAGE_BUTTON | BUTTON_WITH_PAYLOAD;

BUTTON_DEFINITION: 'button' BUTTON;


/* Carousel cards */
ATTRIBUTE: 'set' IDENTIFIER EXPRESSION;
CARD_BODY: ATTRIBUTE+[SEPARATOR] BUTTON_DEFINITION*[SEPARATOR];
CARD: 'card' COLON CARD_BODY;

CAROUSEL_BODY: CARD_BODY  // For dynamic carousels
             | CARD+;     // For static carousels

CAROUSEL: 'carousel' IDENTIFIER COLON CAROUSEL_BODY 'end';

MENU_BODY: COLON BUTTON_DEFINITION+[SEPARATOR] 'end';
MENU: 'menu' IDENTIFIER STRING? MENU_BODY?;


SET_ENTITY: 'as' ENTITY;
REPLY_BODY: STRING SET_ENTITY? | ENTITY;
REPLY: 'reply' REPLY_BODY;
REPLIES: REPLY+[SEPARATOR] FALLBACK?;
QUICK_REPLIES: 'with' COLON REPLIES;
KEEP_CONTEXT: 'keeping' 'context';

BOT_ASKS: 'ask' STRING+ 'as' OBJECT KEEP_CONTEXT? QUICK_REPLIES?;
BOT_SAYS: 'say' STRING+;
BOT_WAITS: 'wait' IDENTIFIER KEEP_CONTEXT? QUICK_REPLIES?;


/* Experimental, not implemented */
PAGER: 'take' 'next'? INTEGER 'items' 'from' EXPRESSION 'as' IDENTIFIER;

PARAMETERS: OPEN EXPRESSION*[SEPARATOR] CLOSE;

CAROUSEL_CONTENT_SOURCE: 'using' EXPRESSION;
SHOW_COMPONENT: 'show' IDENTIFIER CAROUSEL_CONTENT_SOURCE?;
FLOW_PARAMETER: 'with' 'parameter' EXPRESSION;
CHANGE_FLOW: 'change' 'flow' IDENTIFIER FLOW_PARAMETER?;
OPEN_FLOW: 'open' 'flow' IDENTIFIER;
AS_VAR: 'as' OBJECT;
CALL_FUNCTION: 'call' IDENTIFIER PERIOD IDENTIFIER PARAMETERS? AS_VAR?;

VAR_BODY: EXPRESSION | LITERAL_OBJECT | JSON_VALUE;
SET_VAR: 'var' OBJECT '=' VAR_BODY;

SET_ARRAY: 'array' OBJECT '=' EXPRESSION+[SEPARATOR];

EQUALS: VARIABLE 'not'? 'equal' EXPRESSION;
HAS_ENTITY: VARIABLE 'has' 'entity' ENTITY;
IS_EMPTY: VARIABLE 'is' 'not'? 'empty';

CONDITION: EQUALS
         | HAS_ENTITY
         | IS_EMPTY;

ACTION: BOT_ASKS
      | BOT_SAYS
      | BOT_WAITS
      | CALL_FUNCTION
      | CHANGE_FLOW
      | OPEN_FLOW
      | SET_VAR
      | SET_ARRAY
      | SHOW_COMPONENT
      | SUBSCRIBE_FEED
      | UNSUBSCRIBE_FEED
      | HANDOFF_ACTION
      ;

IF: 'if' CONDITION IF_BODY;
IF_BODY: COLON ACTION ELSE? | ACTION+ IF_CLOSURE;
IF_CLOSURE: END | ELSE;

ELSE: 'else' ELSE_BODY;
ELSE_BODY: COLON ACTION | ACTION+ END;

STATEMENT: ACTION | IF ;
BLOCK: DO STATEMENT+ DONE;

FLOW_INTENT: 'given' INTENT;
FLOW_TYPE: 'fallback' | 'qna';
FLOW: FLOW_TYPE? 'flow' IDENTIFIER FLOW_INTENT? BLOCK;
